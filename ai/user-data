#cloud-config
autoinstall:
  version: 1

  # ===== 基本設定 =====
  locale: ja_JP.UTF-8
  keyboard:
    layout: jp
  timezone: Asia/Tokyo

  identity:
    hostname: ubuntu
    username: ubuntu
    # パスワード(例) "P@ssw0rd!" の SHA-512。自分の値に差し替えて下さい。
    # 生成例: mkpasswd --method=SHA-512
    password: "$6$ToReplaceWithYourOwnHash$kOa3c9f8Q0i1...."  # ←差し替え推奨

  ssh:
    install-server: true
    # 公開鍵があれば入れてください（パスワードログイン無効化するなら併用推奨）
    authorized-keys: []
    allow-pw: true

  # ===== インストーラ更新/パッケージ更新を無効化 =====
  # インストーラ自身の更新をしない
  refresh-installer: false
  # ミラーに繋がらず ISO のみを使う（実質、インストール時の更新なし）
  apt:
    preserve_sources_list: true
    geoip: false
    primary:
      - arches: [default]
        uri: "cdrom:"   # ← これでISO内パッケージのみ使用

  # ===== ストレージ構成 (UEFI, RAID1) =====
  storage:
    config:
      # -- nvme5n1 --
      - id: disk-nvme5
        type: disk
        ptable: gpt
        wipe: superblock-recursive
        path: /dev/nvme5n1

      - id: nvme5-esp
        type: partition
        device: disk-nvme5
        size: 536870912      # 512MiB
        flag: boot
        number: 1

      - id: nvme5-mdpart
        type: partition
        device: disk-nvme5
        size: -1
        number: 2

      # -- nvme6n1 --
      - id: disk-nvme6
        type: disk
        ptable: gpt
        wipe: superblock-recursive
        path: /dev/nvme6n1

      - id: nvme6-esp
        type: partition
        device: disk-nvme6
        size: 536870912
        flag: boot
        number: 1

      - id: nvme6-mdpart
        type: partition
        device: disk-nvme6
        size: -1
        number: 2

      # -- mdadm RAID1 for root --
      - id: md0
        type: raid
        name: md0
        raidlevel: 1
        devices: [nvme5-mdpart, nvme6-mdpart]
        spare_devices: []

      # -- filesystems & mounts --
      - id: fs-esp
        type: format
        fstype: fat32
        volume: nvme5-esp      # メインのESP（後で2ndにも複製）
        label: ESP

      - id: fs-root
        type: format
        fstype: ext4
        volume: md0
        label: rootfs

      - id: mount-esp
        type: mount
        device: fs-esp
        path: /boot/efi

      - id: mount-root
        type: mount
        device: fs-root
        path: /

  # ===== GRUB を両ディスクに入れる =====
  grub:
    install_devices: [/dev/nvme5n1, /dev/nvme6n1]

  # ===== 最小構成インストール（お好みで） =====
  packages: []
  snaps: []
  user-data:
    disable_root: false

  # ===== 仕上げ：もう片方のESPにもEFIを複製（UEFIフェイルオーバー用） =====
  late-commands:
    # 2nd ESP を一時マウント
    - curtin in-target -- mount /dev/nvme6n1p1 /mnt
    # EFI 内容を複製
    - curtin in-target -- bash -c 'rsync -aHAX --delete /boot/efi/ /mnt/'
    # 念のため再インストール（UEFIエントリ再作成）
    - curtin in-target -- bash -c 'grub-install --target=x86_64-efi --efi-directory=/mnt --bootloader-id=ubuntu --recheck'
    - curtin in-target -- umount /mnt
